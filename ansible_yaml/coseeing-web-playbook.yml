- name: Show Docker Compose Running Status
  hosts: all
  become: true
  become_user: root
  vars_files:
    - common/vars.yml
  vars:
    docker_compose_dir: "/data/coseeing-web{{ project_postfix }}"
    secret_name: prod/rdsuser/coseeing
    traefik_certresolver: "coseeing-web{{ project_postfix }}"
    traefik_router_prefix: "coseeing-web-service{{ project_postfix }}--"
    image_name: "{{ ecr_location }}/coseeing-fe:{{ deploy_tag }}"
    project_name: coseeing-web
  collections:
    - community.docker
    - community.aws
  tasks:
    - name: Include pre-common tasks
      include_tasks: common/pre-common.yml

    - name: Create .env file
      copy:
        dest: "{{ docker_compose_dir }}/.env"
        content: |
          {% if project_postfix == "-dev" %}
          NEXT_PUBLIC_BASE_URL=https://api.dev.coseeing.org/about/api
          {% else %}
          NEXT_PUBLIC_BASE_URL=https://api.coseeing.org/about/api
          {% endif %}
          NEXT_PUBLIC_GOOGLE_TAG_MANAGER_ID=GTM-NQQ79V67

    - name: Copy docker-compose.yml Document
      copy:
        dest: "{{ docker_compose_dir }}/docker-compose.yml"
        content: |
          version: "3.7"
          services:
            coseeing-web:
              container_name: "coseeing-web{{ project_postfix }}"
              image: {{ image_name }}
              restart: always
              deploy:
                resources:
                  limits:
                    cpus: '0.70'
                    memory: '1G'
              labels: {{ (['traefik.enable=true', 'traefik.docker.network=entry'] + traefik_labels_list) | to_json }}
              networks:
                - default
                - entry
              env_file:
                - .env

          networks:
            entry:
              driver: bridge
              name: entry

    - name: Include post-common tasks
      include_tasks: common/post-common.yml
